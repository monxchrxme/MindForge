"""
Parser Agent - анализирует заметку и извлекает ключевые факты
Базируется на коде из Gigachat.ipynb
"""

from typing import Dict, Any, List
from langchain_core.messages import AIMessage
from langchain_core.prompts import ChatPromptTemplate

from .base_agent import BaseAgent
from ..utils.gigachat_client import create_gigachat_parser_client


class ParserAgent(BaseAgent):
    """
    Агент для парсинга заметок и извлечения ключевых фактов
    Использует GigaChat с temperature=0.2 для детерминированного вывода
    """

    def __init__(self):
        super().__init__("ParserAgent")

        # Создание GigaChat клиента (твоя функция)
        self.llm = create_gigachat_parser_client()

        # Промпт из твоего кода
        self.system_prompt = ChatPromptTemplate.from_messages([
            ("system", """Ты — эксперт-аналитик образовательного контента с многолетним опытом работы в академической среде.

Твоя основная задача: тщательно проанализировать предоставленный текст лекции и извлечь наиболее значимые ключевые факты, которые студент должен запомнить для глубокого понимания темы.

КРИТЕРИИ ОТБОРА ФАКТОВ:
1. Полнота и самодостаточность — каждый факт представляет собой законченное, самостоятельное утверждение, которое можно понять вне контекста лекции
2. Проверяемость и конкретность — факты должны содержать конкретные определения, формулы, даты, названия, числовые данные или четкие логические связи
3. Приоритет важности — отбирай только концептуально значимую информацию: определения ключевых терминов, основные теоремы, законы, формулы, исторические вехи, причинно-следственные связи
4. Точность формулировок — сохраняй терминологию и научную строгость из оригинального текста
5. Избегай повторов — каждый факт должен нести уникальную информацию

КОЛИЧЕСТВО: извлеки от 5 до 8 ключевых фактов в зависимости от насыщенности материала.

ФОРМАТ ВЫВОДА:
- Каждый факт начинается с дефиса "-" и новой строки
- Факт формулируется как одно полное предложение (допустимо 2-3 предложения, если информация сложная)
- НЕ добавляй нумерацию, заголовки, комментарии или метаинформацию
- НЕ пиши вводных фраз типа "Вот факты:" или "Список фактов:"

ПРИМЕР КОРРЕКТНОГО ВЫВОДА:
- Производная функции f(x) обозначается как f'(x) и показывает скорость изменения функции в данной точке
- Геометрический смысл производной — тангенс угла наклона касательной к графику функции в заданной точке
- Производная константы равна нулю, так как константа не изменяется
- Правило дифференцирования суммы: (f+g)' = f' + g'
- Производная степенной функции x^n равна n·x^(n-1)

Анализируй лекцию внимательно, выделяя фундаментальные знания, которые формируют понимание темы."""),
            ("user", "Текст лекции:\n\n{lecture_text}\n\nИзвлеки ключевые факты согласно заданным критериям:")
        ])

    def process(self, state: Dict[str, Any]) -> Dict[str, Any]:
        """
        Основной метод парсинга (твоя функция parser_agent)

        Args:
            state: словарь с ключом "lecture_text"

        Returns:
            обновленный state с "key_facts"
        """
        self.logger.info("Парсер агент запущен...")

        lecture_text = state["lecture_text"]

        # Создание chain (твой код)
        chain = self.system_prompt | self.llm

        # Вызов GigaChat API
        response = chain.invoke({"lecture_text": lecture_text})
        facts_text = response.content

        # Парсинг фактов из ответа (твой код)
        facts = [
            line.strip().lstrip("- ").lstrip("• ")
            for line in facts_text.split("\n")
            if line.strip() and (line.strip().startswith("-") or line.strip().startswith("•"))
        ]

        # Обновление state
        state["key_facts"] = facts
        state["messages"].append(AIMessage(content=f"Parser Agent извлек {len(facts)} фактов"))
        state["current_step"] = "parsing_complete"

        self.logger.info(f"Извлечено {len(facts)} ключевых фактов")

        return state

# TODO: Добавить RAG систему для длинных заметок
# TODO: Добавить кэширование результатов парсинга
# TODO: Добавить валидацию фактов (проверка, что извлечено 5-8 фактов)
