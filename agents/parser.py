#TODO написать норм промт для code стратегии
from services.gigachat_client import GigaChatClient
from services.cache_manager import CacheManager
from utils.hashing import compute_hash
import logging
from typing import Any, Dict, List

logger = logging.getLogger(__name__)
class ParserAgent:
    def __init__(self, client: GigaChatClient, cache_manager: CacheManager, cache_enabled: bool = True):
        """
        :param client: Экземпляр GigaChatClient
        :param cache_manager: Экземпляр CacheManager
        :param cache_enabled: Включать ли кэширование концептов (True/False)
        """
        self.client = client
        self.cache_manager = cache_manager
        self.cache_enabled = cache_enabled

    def parse_note(self, text: str) -> list:
        """
        Принимает сырой текст заметки.
        1. Вычисляет хеш.
        2. Проверяет и при необходимости читает кэш.
        3. Если нет кэша — вызывает LLM для извлечения концептов.
        4. Сохраняет результат в кэш при необходимости.
        5. Возвращает список концептов (list of dict).
        """
        note_hash = compute_hash(text)
        if self.cache_enabled:
            cached = self.cache_manager.get(note_hash)
            if cached is not None:
                return cached

        concepts = self._extract_concepts_from_llm(text)
        print("Извлечённые концепты из LLM:")
        for concept in concepts:
            print(f" - {concept['term']}: {concept['definition']}")
        logger.info("Извлечённые концепты (LLM): %s",
                    "; ".join(f"{c['term']}: {c['definition']}" for c in concepts))
        if self.cache_enabled:
            self.cache_manager.save(note_hash, concepts)
        return concepts

    def parse_code_note(self, text: str) -> List[Dict[str, Any]]:
        """
        Специализированный парсинг для заметок с кодом.
        Извлекает ключевые концепты И связанные с ними куски кода.
        """
        logger.info("ParserAgent: Running CODE extraction mode")

        prompt = (
            f"Проанализируй эту техническую заметку. Твоя задача — выделить пары 'Теория + Код'.\n"
            f"Ищи определения, паттерны или алгоритмы, которые иллюстрируются кодом в тексте.\n\n"
            f"Текст:\n{text}\n\n"  # Ограничение токенов
            f"Верни JSON-список объектов:\n"
            f"[\n"
            f"  {{\n"
            f"    \"term\": \"Название концепта/паттерна/функции\",\n"
            f"    \"definition\": \"Краткое теоретическое объяснение\",\n"
            f"    \"code_snippet\": \"Кусок кода, который к этому относится (или null, если кода нет)\"\n"
            f"  }}\n"
            f"]\n"
            f"Если кода нет, поле code_snippet оставь пустым или null."
        )

        try:
            result = self.client.generate_json(prompt)
            # Валидация и очистка
            valid_items = []
            if isinstance(result, list):
                for item in result:
                    if item.get("term") and (item.get("definition") or item.get("code_snippet")):
                        valid_items.append(item)

            logger.info(f"Extracted {len(valid_items)} code-concept pairs")
            return valid_items

        except Exception as e:
            logger.error(f"Code parsing failed: {e}")
            return []

    def _extract_concepts_from_llm(self, text: str) -> list:
        """
        Формирует промпт, отправляет в GigaChat, возвращает список концептов.
        """
        prompt = (
            "Вы — интеллектуальный помощник-методист с глубокими знаниями в образовательных дисциплинах. "
            "Ваша задача — извлечь из учебной заметки ключевые концепты и составить для каждого максимально полное и полезное определение.\n\n"

            "ВАЖНО: Определение должно быть самодостаточным и образовательно ценным. Это означает:\n"
            "1. Если в тексте явно указаны свойства, характеристики или связи концепта — обязательно включите их в определение.\n"
            "2. Если в тексте указано только базовое определение БЕЗ свойств и связей — вы должны:\n"
            "   • Дополнить определение общеизвестными ключевыми свойствами концепта (из вашей базы знаний).\n"
            "   • Добавить 2-3 самых важных связи с другими релевантными понятиями (которые студент должен знать).\n"
            "   • Использовать только проверенные, общепринятые в науке факты — никаких домыслов.\n"
            "3. Если свойства и связи частично упомянуты в тексте — дополните их недостающими важными деталями для полноты картины.\n\n"

            "Структура определения (всё в одном поле definition):\n"
            "— Начните с чёткой формулировки понятия.\n"
            "— Далее перечислите ключевые свойства и характеристики (из текста + ваши дополнения, если необходимо).\n"
            "— Завершите описанием важнейших связей с другими концептами (противопоставление, использование, следствие, примеры и т.д.).\n\n"

            "Примеры правильного подхода:\n\n"

            "Пример 1 (в тексте только определение):\n"
            "Исходный текст: «Фотосинтез — процесс преобразования света в энергию».\n"
            "Ваш вывод:\n"
            "{\n"
            "  \"term\": \"Фотосинтез\",\n"
            "  \"definition\": \"Фотосинтез — биохимический процесс, при котором растения и некоторые бактерии преобразуют световую энергию в химическую. "
            "Происходит в хлоропластах с участием хлорофилла, требует воды и углекислого газа, выделяет кислород как побочный продукт. "
            "Противоположен процессу дыхания (окисление органики), является основой пищевых цепей в экосистемах и источником атмосферного кислорода.\"\n"
            "}\n\n"

            "Пример 2 (в тексте есть свойства, но нет связей):\n"
            "Исходный текст: «Хлорофилл — зелёный пигмент, поглощает свет».\n"
            "Ваш вывод:\n"
            "{\n"
            "  \"term\": \"Хлорофилл\",\n"
            "  \"definition\": \"Хлорофилл — зелёный пигмент, находящийся в хлоропластах растений, поглощает преимущественно красный и синий свет, "
            "отражает зелёный (отсюда цвет растений). Является ключевым компонентом фотосинтеза, без него невозможно преобразование световой энергии. "
            "Существует несколько типов (хлорофилл a, b), различающихся по спектру поглощения.\"\n"
            "}\n\n"

            "Пример 3 (в тексте полная информация):\n"
            "Исходный текст: «Митохондрии — органеллы клетки, производят АТФ, имеют двойную мембрану, содержат собственную ДНК, участвуют в дыхании».\n"
            "Ваш вывод:\n"
            "{\n"
            "  \"term\": \"Митохондрии\",\n"
            "  \"definition\": \"Митохондрии — органеллы эукариотических клеток, отвечающие за производство АТФ (энергетической валюты клетки). "
            "Имеют двойную мембрану, содержат собственную кольцевую ДНК (что указывает на симбиотическое происхождение), участвуют в процессе клеточного дыхания. "
            "Тесно связаны с процессом окисления глюкозы и цикла Кребса, противоположны хлоропластам по функции (митохондрии расходуют кислород, хлоропласты его производят).\"\n"
            "}\n\n"

            "Формат вывода:\n"
            "— JSON-список словарей с полями term и definition.\n"
            "— Не используйте Markdown-блоки, вводные комментарии или пояснения.\n"
            "— Строго следуйте формату для автоматической обработки.\n"
            "— Выделяйте только значимые концепты из текста, не добавляйте термины, которых там нет.\n\n"

            "Текст заметки:\n"
            f"{text}"
        )

        result = self.client.generate_json(prompt)
        # Опционально: валидация структуры результата здесь
        if not isinstance(result, list):
            raise ValueError("GigaChat вернул неожиданный формат (ожидается список концептов)")
        return result