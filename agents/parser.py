from services.gigachat_client import GigaChatClient
from services.cache_manager import CacheManager
from utils.hashing import get_hash

class ParserAgent:
    def __init__(self, client: GigaChatClient, cache_manager: CacheManager, cache_enabled: bool = True):
        """
        :param client: Экземпляр GigaChatClient
        :param cache_manager: Экземпляр CacheManager
        :param cache_enabled: Включать ли кэширование концептов (True/False)
        """
        self.client = client
        self.cache_manager = cache_manager
        self.cache_enabled = cache_enabled

    def parse_note(self, text: str) -> list:
        """
        Принимает сырой текст заметки.
        1. Вычисляет хеш.
        2. Проверяет и при необходимости читает кэш.
        3. Если нет кэша — вызывает LLM для извлечения концептов.
        4. Сохраняет результат в кэш при необходимости.
        5. Возвращает список концептов (list of dict).
        """
        note_hash = get_hash(text)
        if self.cache_enabled:
            cached = self.cache_manager.get(note_hash)
            if cached is not None:
                return cached

        concepts = self._extract_concepts_from_llm(text)
        print("Извлечённые концепты из LLM:")
        for concept in concepts:
            print(f" - {concept['term']}: {concept['definition']}")
        logger.info("Извлечённые концепты (LLM): %s",
                    "; ".join(f"{c['term']}: {c['definition']}" for c in concepts))
        if self.cache_enabled:
            self.cache_manager.save(note_hash, concepts)
        return concepts

    def _extract_concepts_from_llm(self, text: str) -> list:
        """
        Формирует промпт, отправляет в GigaChat, возвращает список концептов.
        """
        prompt = (
            "Вы — интеллектуальный помощник-методист, обладающий экспертными навыками в анализе и структурировании учебных текстов для студентов. "
            "Ваша задача — максимально точно и объективно выделить из переданного ниже фрагмента академической заметки ключевые понятия. Для каждого концепта вы должны:\n"
            "  — дать его имя (term);\n"
            "  — составить развернутое определение (definition), которое включает:\n"
            "     • формулировку основного определения,\n"
            "     • перечисление всех существенных свойств и характеристик этого термина,\n"
            "     • описание самых важных связей с другими ключевыми понятиями из всего текста (например, отношение к ним, зависимость, противоположность, использование, примеры и др.).\n"
            "  Определение должно быть объединено в один структурированный текст, без подразделения на списки, чтобы студент мог по единой строке понять суть, свойства и связи термина.\n\n"
            "Инструкция:\n"
            "1. Не добавляйте лишних терминов, опирайтесь только на исходный текст.\n"
            "2. Не используйте отдельные разделы properties, relations и не выводите отдельные списки — все характеристики и связи включайте непосредственно в поле definition.\n"
            "3. Формат вывода: JSON-список словарей, только поля term и definition, строго как в примере:\n"
            "[\n"
            "  {\n"
            "    \"term\": \"Фотосинтез\",\n"
            "    \"definition\": \"Фотосинтез — это процесс, происходящий в хлоропластах растений с участием хлорофилла, при котором световая энергия преобразуется в химическую, использует воду и углекислый газ, выделяет кислород, противопоставляется дыханию и определяет обмен веществ в экосистемах. Хлорофилл необходим для поглощения света, а дыхание — обратный процесс, дополняющий фотосинтез.\"\n"
            "  },\n"
            "  {\n"
            "    \"term\": \"Хлорофилл\",\n"
            "    \"definition\": \"Хлорофилл — зеленый пигмент, находящийся в хлоропластах растений, необходим для процесса фотосинтеза, поглощает красный и синий свет, обеспечивает преобразование энергии, тесно связан с понятием фотосинтеза и является его ключевым компонентом.\"\n"
            "  }\n"
            "]\n"
            "— Не используйте Markdown-блоки.\n"
            "— Выводите только поля term и definition для каждого концепта, строго согласно формату.\n"
            "— Строго следуйте указанному формату, чтобы результат мог быть автоматически обработан.\n\n"
            "Текст заметки:\n"
            f"{text}"
        )

        result = self.client.generate_json(prompt)
        # Опционально: валидация структуры результата здесь
        if not isinstance(result, list):
            raise ValueError("GigaChat вернул неожиданный формат (ожидается список концептов)")
        return result